services:
  wuzapi-server:
    # IMPORTANTE: Usando a seção "build" para construir a partir do seu código.
    build:
      context: .
      dockerfile: Dockerfile
    # A seção "ports" continua removida para o EasyPanel gerenciar.
    environment:
      WUZAPI_PORT: '8080'
      WUZAPI_ADMIN_TOKEN: 'AdminToken_f3e2d1c0b9a8f7e6d5c4b3a2e1d0f9e8'
      WUZAPI_GLOBAL_ENCRYPTION_KEY: 'R2h5Jk8mN4pS6rT9uWvYx3zB6cE9gHkM'
      WUZAPI_GLOBAL_HMAC_KEY: 'HmacKey_c1b0a9f8e7d6c5b4a3e2d1c0b9a8f7e6d5c4b3a2'
      WUZAPI_GLOBAL_WEBHOOK: 'https://n8n.cdnproxy.top/webhook/chatwoot'
      WEBHOOK_FORMAT: 'json'
      SESSION_DEVICE_NAME: 'WuzAPI'
      TZ: 'America/Sao_Paulo'
      DB_HOST: 'ep-bold-scene-aderly70-pooler.c-2.us-east-1.aws.neon.tech'
      DB_PORT: '5432'
      DB_USER: 'neondb_owner'
      DB_PASSWORD: 'npg_YG05lxZMOcNF'
      DB_NAME: 'neondb'
      DB_SSLMODE: 'require'
      RABBITMQ_URL: 'amqp://wuzapi:wuzapi@rabbitmq:5672/'
      RABBITMQ_QUEUE: 'whatsapp_events'
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - wuzapi-network
    restart: on-failure

  rabbitmq:
    image: rabbitmq:3-management
    hostname: rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: wuzapi
      RABBITMQ_DEFAULT_PASS: wuzapi
      RABBITMQ_DEFAULT_VHOST: /
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - wuzapi-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always

networks:
  wuzapi-network:
    driver: bridge

volumes:
  rabbitmq_data:
  wuzapi_data:
